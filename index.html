<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>4th International Symposium 2026 - Admin Dashboard</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

    <style>
        :root {
            --primary: #4361ee; --secondary: #7209b7; --success: #10b981;
            --danger: #f72585; --dark: #212529; --gray: #6c757d;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; font-size: 13px;
        }

        .container {
            width: 98%; max-width: 1200px; background: white; border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.50); display: flex; flex-direction: column;
        }

        .header { padding: 6px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .banner-img { height: 100px; } 

        #flowOverlay, #statsOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: none; overflow: hidden;
        }
        #statsOverlay { background: #f8fafc; padding: 40px; box-sizing: border-box; flex-direction: column; align-items: center; justify-content: center; }

        .flow-content { width: 100%; position: absolute; left: 0; }
        .close-flow { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: var(--danger); color: white; border: none; cursor: pointer; z-index: 10000; border-radius: 5px; font-weight: bold; }

        .status-indicator { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: bold; padding: 4px 10px; border-radius: 20px; background: #f1f5f9; }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .dot-online { background-color: var(--success); box-shadow: 0 0 8px var(--success); }
        .dot-offline { background-color: var(--danger); }
        .dot-sync { background-color: orange; box-shadow: 0 0 6px orange; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; text-align: center; max-width: 500px; width: 90%; }
        .modal-qr-container { width: 320px; height: 320px; margin: 0 auto 15px auto; transition: 0.5s; transform: scale(0); opacity:0; }
        .modal-qr-container.active { transform: scale(1); opacity:1; }

        .controls { padding: 6px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .controls-grid { display: grid; grid-template-columns: 1fr 1.2fr 1.2fr; gap: 15px; align-items: start; }
        .btn-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 4px; }

        .btn { padding: 7px 10px; border-radius: 5px; border: 1px solid #d1d5db; font-weight: 600; cursor: pointer; transition: 0.15s; font-size: 11px; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-sync { background: var(--secondary); color: white; border: none; }
        .btn-success { background: var(--success); color: white; border: none; }
        .btn-danger { background: var(--danger); color: white; border: none; }
        .btn-flow { background: #ff9f43; color: white; border: none; }

        .dual-guest-group { display: flex; margin-top: 4px; height: 30px; }
        .btn-guest-main { flex: 1; border-radius: 5px 0 0 5px; background: var(--primary); color: white; border: none; font-size: 11px; cursor: pointer; font-weight: 600; }
        .btn-guest-arrow { width: 80px; border-radius: 0 5px 5px 0; background: #3046bc; color: white; border: none; border-left: 1px solid rgba(255,255,255,0.2); font-size: 10px; cursor: pointer; }
        
        /* GUEST PANEL - SOFT BUTTON STYLES */
        .guest-grid { display: none; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; background: #f4f7ff; padding: 12px; border-radius: 10px; border: 1px solid #e0e7ff; }
        .btn-mini { padding: 8px 2px; font-size: 10px; font-weight: 600; text-transform: uppercase; background: white; color: #4361ee; border: 1.5px solid #4361ee; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; text-align: center; display: flex; align-items: center; justify-content: center; }
        .btn-mini:hover { background: #4361ee; color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2); transform: translateY(-1px); }

        .main-content { display: grid; grid-template-columns: 1.4fr 0.6fr; gap: 10px; padding: 10px 20px; }
        .panel { background: white; padding: 12px 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: var(--shadow); position: relative;}
        .display-name { color: var(--primary); font-weight: 600; font-size: 1.1rem; border: 1px solid #eee; padding: 4px 10px; min-width: 250px; display: inline-block; }

        .qr-frame { width: 220px; height: 220px; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; background: white; position: relative; overflow: hidden; cursor: pointer; }
        .qr-curtain { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #3d5a80; transition: transform 0.6s; z-index: 10; transform-origin: top; }
        .qr-curtain.open { transform: scaleY(0); }

        .info-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .info-item { background: #f9fafb; padding: 8px 10px; border-radius: 6px; border: 1px solid #eee; }
        footer { padding: 6px; text-align: center; font-size: 10px; color: var(--gray); border-top: 1px solid #f1f5f9; }
        input[type="text"], select { width: 100%; padding: 7px; border-radius: 5px; border: 1px solid #ccc; font-size: 13px; }

        .stats-grid p { margin: 3px 0; display: flex; justify-content: space-between; font-size: 11px; }

        .fs-stats-card { background: white; border-radius: 20px; padding: 40px; width: 95%; max-width: 1200px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); text-align: center; }
        .fs-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; margin-top: 30px; }
        .fs-val { font-size: 1.6rem; font-weight: 800; color: var(--primary); display: block; }
        .fs-label { color: var(--gray); text-transform: uppercase; font-size: 8px; letter-spacing: 1px; }
    /* IMPROVED PROGRAM FLOW STYLES */
#flowOverlay {
    background: rgba(0, 0, 0, 0.95); /* Darker backdrop for focus */
}

.flow-container {
    display: flex;
    gap: 20px;
    width: 90%;
    margin: 0 auto;
    padding: 50px 0;
}

.flow-column {
    flex: 1;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    overflow: hidden;
    height: 1500px; /* Adjust based on PDF content length */
}

.flow-column iframe {
    width: 100%;
    height: 100%;
    border: none;
}

</style>
</head>
<body>

<div id="flowOverlay">
    <button class="close-flow" onclick="stopFlow()">‚úñ Close (Esc)</button>
    <div id="scroller" class="flow-content">
        <div class="flow-container">
            <div class="flow-column">
                <iframe src="4th Symposium Program Flow.pdf#toolbar=0&navpanes=0"></iframe>
            </div>
            
        </div>
    </div>
</div>

<div id="statsOverlay">
    <button class="close-flow" onclick="closeStats()">‚úñ Close (Esc)</button>
    <div class="fs-stats-card">
        <h1 style="color:var(--primary); margin-top:0;">Live Symposium Analytics</h1>
        <p id="fsCalculationLabel" style="color:var(--gray); font-size: 1.4rem; margin-bottom: 20px; font-weight: bold;">
            Total Present: = 0 (ATTENDANCE RATE: 0%)
        </p>
        <div style="height: 400px; width: 100%; margin: 20px 0;"><canvas id="fsStatChart"></canvas></div>
        <div class="fs-grid">
            <div><span class="fs-val" id="fsPreReg">0</span><span class="fs-label">Pre-Reg</span></div>
            <div><span class="fs-val" id="fsCheckIn" style="color:var(--success)">0</span><span class="fs-label">Check-in</span></div>
            <div><span class="fs-val" id="fsOnsite" style="color:var(--danger)">0</span><span class="fs-label">On-Site Reg</span></div>
            <div><span class="fs-val" id="fsGuestStat" style="color:var(--secondary)">0</span><span class="fs-label">Guests</span></div>
            <div><span class="fs-val" id="fsStaffStat" style="color:#f39c12">0</span><span class="fs-label">Staff</span></div>
            <div><span class="fs-val" id="fsStudentStat" style="color:#00b4d8">0</span><span class="fs-label">Students</span></div>
            <div><span class="fs-val" id="fsSpeakerStat" style="color:var(--dark)">0</span><span class="fs-label">Speakers</span></div>
            <div><span class="fs-val" id="fsOrgStat" style="color:var(--gray)">0</span><span class="fs-label">Organisers</span></div>
        </div>
    </div>
</div>

<div class="container" id="mainDashboard">
  <div class="header">
    <div class="header-left">
        <img src="Certi-logo.png" class="banner-img" alt="ASU Banner">
        <img src="clfs-logo.png" class="banner-img" alt="CLFS Logo" style="margin-left: 5px;">
        <div>
            <h2 style="margin:0; font-size:1.3rem; color:var(--primary);">4th International Symposium 2026</h2>
            <p style="margin:0; color:var(--gray); font-size: 12px;">Admin Face-to-Face Dashboard</p>
        </div>
    </div>
    <div style="display: flex; gap: 5px; align-items: center;">
        <button class="btn btn-flow" onclick="toggleFullScreen()" style="background:#2d3436; color:white;">‚õ∂ Fullscreen</button>
        <button class="btn btn-flow" onclick="startFlow()">‚ñ∂ Play Flow</button>
        <button class="btn btn-geo" id="geoBtn" onclick="toggleGeoFence()">üìç Location: OFF</button>
        <div class="status-indicator" style="margin-left:8px;">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">READY</span>
        </div>
    </div>
  </div>

  <div class="controls">
    <div class="controls-grid">
      <div>
        <label style="font-size:10px; font-weight:bold; color: var(--gray);">FILTERS</label>
        <div class="btn-pair">
            <button class="btn btn-primary" onclick="filterRole('All')">All</button>
            <button class="btn btn-primary" onclick="filterRole('Participant')">Attendees</button>
        </div>
        <div class="btn-pair">
            <button class="btn btn-primary" onclick="filterRole('Organiser')">Organisers</button>
            <button class="btn btn-primary" onclick="filterRole('Speaker')">Speakers</button>
        </div>
      </div>

      <div>
        <label style="font-size:10px; font-weight:bold; color: var(--gray);">GUEST LIST & MANAGEMENT</label>
        <div class="btn-pair" style="grid-template-columns: 1fr;">
            <button class="btn btn-sync" id="syncBtn" onclick="handleDataAction()">üìÇ Sync Cloud & ‚¨ÜÔ∏è Upload CSV</button>
            <input type="file" id="uploadFiles" style="display:none" accept=".csv" multiple onchange="handleFileUpload(this)">
        </div>
        
        <div class="dual-guest-group">
            <button class="btn btn-guest-main" onclick="filterRole('Guest')">üë§ Guest List</button>
            <button class="btn btn-guest-arrow" onclick="toggleGuestPanel()">‚ñº Quick Add</button>
        </div>

        <div id="guestPanel" class="guest-grid">
            <button class="btn-mini" onclick="quickAddGuest('Min/VIP', 'Guest')">VIP</button>
            <button class="btn-mini" onclick="quickAddGuest('BoT/BoD', 'Guest')">BoT/BoD</button>
            <button class="btn-mini" onclick="quickAddGuest('VC/DVC', 'Guest')">VC/DVC</button>
            <button class="btn-mini" onclick="quickAddGuest('Dean/Dir', 'Guest')">Deans/Directors</button>
            <button class="btn-mini" onclick="quickAddGuest('ASU Staff', 'Staff')">ASU Staff</button>
            <button class="btn-mini" onclick="quickAddGuest('ASU Stud', 'Student')">ASU Students</button>
            <button class="btn-mini" onclick="quickAddGuest('Media', 'Guest')">Press/Media</button>
            <button class="btn-mini" onclick="customGuest()">+Custom</button>
        </div>
      </div>

      <div>
        <label style="font-size:10px; font-weight:bold; color: var(--gray);">SEARCH & QR ACCESS</label>
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 4px;">
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <button class="btn" style="background:#3a0ca3; color:white; padding: 7px 5px;" onclick="showSecureQR('PRE-REG')">üì± Pre-Reg</button>
                <button class="btn" style="background:linear-gradient(to right, #f72585, #4361ee); color:white; padding: 7px 5px;" onclick="showSecureQR('ON-SITE')">üì± On-Site</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <input type="text" id="searchBox" placeholder="üîç Search name..." onkeyup="handleSearch(this.value)">
                <select id="combinedDropdown"><option value="">Select Participant...</option></select>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="panel">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
          <button class="btn btn-success" style="padding: 10px 18px;" id="btnMarkPresent" onclick="togglePresence()">‚òë Mark Present</button>
          <span class="display-name" id="displayName">No Selection</span>
        </div>
        <div style="display:flex; gap:20px; align-items:flex-start;">
          <div class="qr-frame" onclick="handleCurtainClick()">
              <div id="qrCurtain" class="qr-curtain"></div>
              <img id="mainQrImg" src="4th Symposium Check-in QR.png" style="width:100%">
          </div>
          <div class="info-grid">
            <div class="info-item"><b>Status</b><div id="valStatus" style="font-weight:bold; color:var(--danger);">-</div></div>
            <div class="info-item"><b>Category</b><div id="valCategory">-</div></div>
            <div class="info-item" style="grid-column: span 2;"><b>Institution</b><div id="valInstitution">-</div></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; grid-column: span 2;">
                <button class="btn" style="background:#2d3436; color:white" onclick="downloadReport()">üìÑ Report</button>
                <button class="btn" style="background:#1a3a82; color:white" onclick="openCertLink()">üéì E-Certs</button>
            </div>
          </div>
        </div>
    </div>
    
    <div class="panel">
      <h4 style="margin:0 0 5px 0; color: var(--secondary); border-bottom: 2px solid #eee; padding-bottom: 3px;">üìä Stats Breakdown</h4>
      <div id="statsContainer">
          <div style="height: 130px; margin-bottom: 10px;"><canvas id="statChart"></canvas></div>
          <div class="stats-grid" id="sidebarStatsList"></div>
          <div style="text-align: center; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px;">
              <div id="statTotalPerc" style="font-size: 18px; font-weight: bold; color: var(--primary);"> 0%</div>
              <span style="font-size: 9px; color: var(--gray);">ATTENDANCE RATE</span>
          </div>
          <button class="btn btn-primary" style="width:100%; margin-top:10px; background:var(--secondary);" onclick="showFullscreenStats()">üìä Full Screen Stats</button>
      </div>
    </div>
  </div>
  <footer>
  <a href="https://www.asu.edu.om/" target="_blank" class="univ-link">A'Sharqiyah University </a>: P.O Box 42, Postal Code:400 Ibra, Sultanate of Oman.
<a href="https://www.asu.edu.om/Page/Details/25?t=Centre%20for%20Language%20and%20Foundation%20Studies">Center For Language and Foundation Studies</a>. Copyright <span class="copyright">&copy; <a href="mailto:hrehman08@yahoo.com">drkhan</a> <span id="year"></span></span>.
</footer>
</div>

<div id="regModal" class="modal-overlay">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="modalTitle" style="color:var(--primary); margin-bottom:5px;">Registration</h2>
        <p id="modalAttendee" style="font-weight:bold; color:var(--gray); margin-bottom:15px;"></p>
        <div id="regModalQR" class="modal-qr-container"></div>
        <div style="background: #fff5f5; padding: 10px; border-radius: 8px;">
            <span style="font-size: 10px; color: #c53030; text-transform: uppercase;">Time Remaining</span>
            <div id="expiryTimer" style="color:var(--danger); font-size: 22px; font-weight:bold; font-family: monospace;">02:00</div>
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:15px; padding:10px;" onclick="closeModal()">Close</button>
    </div>
</div>

<script>
let attendees = JSON.parse(localStorage.getItem('asuDashboardAttendees')) || [];
let currentIdx = -1, isGeoFenceEnabled = false;
let qrExpiryInterval, idleTimer, animId;
let scrollPos = 0, myChart, fsChart;

// High-Contrast Colorful QR Configuration
const modalQR = new QRCodeStyling({
    width: 320,
    height: 320,
    type: "svg",
    data: "",
    dotsOptions: {
        color: "#4361ee",
        type: "extra-rounded",
        gradient: {
            type: "linear",
            rotation: 45,
            colorStops: [
                { offset: 0, color: "#4361ee" },
                { offset: 1, color: "#f72585" }
            ]
        }
    },
    backgroundOptions: { color: "#ffffff" },
    cornersSquareOptions: { type: "extra-rounded", color: "#3a0ca3" },
    cornersDotOptions: { type: "dot", color: "#7209b7" }
});

function initChart() {
    const ctx = document.getElementById('statChart').getContext('2d');
    const fsCtx = document.getElementById('fsStatChart').getContext('2d');
    const labels = ['Pre-Reg', 'On-Site', 'Guests', 'Staff', 'Students', 'Speakers', 'Organisers'];
    
    const chartConfig = {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Present',
                    backgroundColor: ['#10b981', '#f72585', '#7209b7', '#f39c12', '#00b4d8', '#212529', '#6c757d'],
                    data: new Array(7).fill(0),
                    borderRadius: 4
                },
                {
                    label: 'Pending',
                    backgroundColor: ['#ef4444', 'transparent', 'transparent', 'transparent', 'transparent', 'transparent', 'transparent'],
                    data: new Array(7).fill(0),
                    borderRadius: 4
                }
            ]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } },
                x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } }
            }
        }
    };

    const fsChartConfig = JSON.parse(JSON.stringify(chartConfig));
    fsChartConfig.options.scales.x.ticks.font = { size: 14, weight: 'bold' };

    myChart = new Chart(ctx, chartConfig);
    fsChart = new Chart(fsCtx, fsChartConfig);
}

function updateStats() {
    const preRegGroup = attendees.filter(p => p.role === 'Participant');
    const preRegTotal = preRegGroup.length;
    const preRegPresent = preRegGroup.filter(p => p.status.includes('‚úÖ')).length;
    const preRegPending = preRegTotal - preRegPresent;
    const onSiteGroup = attendees.filter(p => p.role.includes('New'));
    const onSitePresent = onSiteGroup.filter(p => p.status.includes('‚úÖ')).length;
    
    const stats = {
        onSite: onSiteGroup.length,
        guests: attendees.filter(p => p.role === 'Guest').length,
        staff: attendees.filter(p => p.role === 'Staff').length,
        students: attendees.filter(p => p.role === 'Student').length,
        speakers: attendees.filter(p => p.role === 'Speaker').length,
        organisers: attendees.filter(p => p.role === 'Organiser').length
    };

    const totalCheckIn = attendees.filter(p => p.status.includes('‚úÖ')).length;
    const rate = (attendees.length > 0 ? (totalCheckIn/attendees.length*100).toFixed(1) : 0) + "%";
    
    document.getElementById('fsCalculationLabel').innerHTML = `Total Present: <b> = ${totalCheckIn} (ATTENDANCE RATE: ${rate})</b>`;
    document.getElementById('sidebarStatsList').innerHTML = `
        <p>Pre-Reg Total: <b>${preRegTotal}</b> (Pending: <span style="color:red">${preRegPending}</span>)</p>
        <p>On-Site Reg: <b>${stats.onSite}</b></p>
        <p>Guests: <b>${stats.guests}</b></p>
        <p>Staff: <b>${stats.staff}</b></p>
        <p>Students: <b>${stats.students}</b></p>
        <p>Speakers: <b>${stats.speakers}</b></p>
        <p>Organisers: <b>${stats.organisers}</b></p>
        <hr style="border:0; border-top:1px solid #eee; margin: 5px 0;">
        <p>Total Check-ins: <b style="color:var(--success)">${totalCheckIn}</b></p>
    `;

    const presentDataset = [preRegPresent, onSitePresent, stats.guests, stats.staff, stats.students, stats.speakers, stats.organisers];
    const pendingDataset = [preRegPending, 0, 0, 0, 0, 0, 0];
    [myChart, fsChart].forEach(chart => {
        chart.data.datasets[0].data = presentDataset;
        chart.data.datasets[1].data = pendingDataset;
        chart.update();
    });

    document.getElementById('fsPreReg').textContent = preRegTotal;
    document.getElementById('fsCheckIn').textContent = totalCheckIn;
    document.getElementById('fsOnsite').textContent = stats.onSite;
    document.getElementById('fsGuestStat').textContent = stats.guests;
    document.getElementById('fsStaffStat').textContent = stats.staff;
    document.getElementById('fsStudentStat').textContent = stats.students;
    document.getElementById('fsSpeakerStat').textContent = stats.speakers;
    document.getElementById('fsOrgStat').textContent = stats.organisers;
    document.getElementById('statTotalPerc').textContent = rate;
}

function handleDataAction() { if (confirm("Sync from Cloud?")) syncAll(); else document.getElementById('uploadFiles').click(); }
function toggleGuestPanel() { const p = document.getElementById('guestPanel'); p.style.display = p.style.display === 'grid' ? 'none' : 'grid'; }

function quickAddGuest(label, roleType) {
    const name = `${label} ${(attendees.filter(a => a.name.startsWith(label)).length + 1).toString().padStart(2, '0')}`;
    attendees.push({ name: name, status: "‚úÖ Present", institute: "ASU Guest", role: roleType });
    saveAndRefresh(name);
}

function customGuest() { 
    const name = prompt("Enter Custom Guest Name:"); 
    if(name) {
        attendees.push({ name: name, status: "‚úÖ Present", institute: "External", role: "Guest" });
        saveAndRefresh(name);
    }
}

function saveAndRefresh(name) {
    localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
    filterRole('All'); updateStats(); selectUserByName(name);
}

async function syncAll() {
    const dot = document.getElementById('statusDot'); dot.className = 'dot dot-sync';
    const baseUrl = "https://raw.githubusercontent.com/hameedktk09/cms/main/";
    const files = [
        {n:"4th Symposium 2026 Participants.csv", r:"Participant"}, 
        {n:"4th Symposium 2026 Check-in Participants.csv", r:"Participant"}, 
        {n:"4th Symposium 2026 On-Site Participants.csv", r:"Participant (New)"}, 
        {n:"4th Symposium 2026 Organisers.csv", r:"Organiser"}, 
        {n:"4th Symposium 2026 Speakers.csv", r:"Speaker"}
    ];
    try {
        for(let f of files) { 
            const res = await fetch(baseUrl + encodeURIComponent(f.n)); 
            if(res.ok) processSyncData(await res.text(), f.r); 
        }
        localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
        filterRole('All'); updateStats(); dot.className = 'dot dot-online'; alert("Sync Done!");
    } catch(e) { dot.className = 'dot dot-offline'; }
}

function processSyncData(csv, role) {
    csv.split('\n').forEach((row, idx) => {
        if(idx === 0 || !row.trim()) return;
        const cols = row.split(',');
        if(cols.length > 4) {
            const n = cols[4].trim();
            let status = (role.includes('New') || role === 'Organiser') ? "‚úÖ Present" : "‚ùå Pending";
            const existing = attendees.find(a => a.name === n);
            if(!existing) {
                attendees.push({ name: n, status: status, institute: cols[7]?.trim() || "ASU", role: role });
            } else {
                if(role === 'Organiser' || role === 'Speaker') existing.role = role;
                if(status === "‚úÖ Present") existing.status = status;
            }
        }
    });
}

function handleFileUpload(input) {
    Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            let fname = file.name.toLowerCase();
            let r = "Participant";
            if(fname.includes("speaker")) r = "Speaker";
            else if(fname.includes("organiser")) r = "Organiser";
            else if(fname.includes("onsite") || fname.includes("on-site")) r = "Participant (New)";
            processSyncData(e.target.result, r);
            localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
            filterRole('All'); updateStats();
        };
        reader.readAsText(file);
    });
}

function showSecureQR(type) {
    if(type === 'PRE-REG' && currentIdx === -1) return alert("Select participant first!");
    const modal = document.getElementById('regModal');
    let qrData = type === 'PRE-REG' ? 
        "https://forms.gle/izxwf4pbgJb1UXhTA?id=" + encodeURIComponent(attendees[currentIdx].name) : 
        "https://forms.gle/FtuEVmusMqCerHqC7";

    // UPDATED: Changed to PRE-REGISTRATION
    document.getElementById('modalTitle').textContent = type === 'PRE-REG' ? "PRE-REGISTRATION" : type + " REGISTRATION";
    document.getElementById('modalAttendee').textContent = type === 'PRE-REG' ? attendees[currentIdx].name : "NEW ENTRY";
    modal.style.display = 'flex';
    
    // UPDATED: 2 Minute Timer
    clearInterval(qrExpiryInterval);
    let timeLeft = 120;
    document.getElementById('expiryTimer').textContent = "02:00";

    qrExpiryInterval = setInterval(() => {
        timeLeft--;
        let m = Math.floor(timeLeft/60), s = timeLeft%60;
        document.getElementById('expiryTimer').textContent = `${m}:${s.toString().padStart(2,'0')}`;
        if(timeLeft <= 0) closeModal();
    }, 1000);

    modalQR.update({ data: qrData });
    document.getElementById('regModalQR').classList.add('active');
}

function togglePresence() {
    if(currentIdx === -1) return;
    attendees[currentIdx].status = attendees[currentIdx].status.includes('‚úÖ') ? "‚ùå Pending" : "‚úÖ Present";
    saveAndRefresh(attendees[currentIdx].name);
}

function selectUserByName(name) {
    const p = attendees.find(u => u.name === name);
    if(!p) return;
    currentIdx = attendees.indexOf(p);
    document.getElementById('displayName').textContent = p.name;
    document.getElementById('valStatus').textContent = p.status;
    document.getElementById('valStatus').style.color = p.status.includes('‚úÖ') ? '#10b981' : '#f72585';
    document.getElementById('btnMarkPresent').textContent = p.status.includes('‚úÖ') ? "‚òí Un-Present" : "‚òë Mark Present";
    document.getElementById('btnMarkPresent').className = p.status.includes('‚úÖ') ? "btn btn-danger" : "btn btn-success";
    document.getElementById('valInstitution').textContent = p.institute;
    document.getElementById('valCategory').textContent = p.role;
    document.getElementById('combinedDropdown').value = p.name;
}

function handleSearch(val) { const f = attendees.filter(p => p.name.toLowerCase().includes(val.toLowerCase())); if(f.length > 0) selectUserByName(f[0].name); }

function filterRole(role) {
    const dd = document.getElementById('combinedDropdown');
    dd.innerHTML = '<option value="">Select Participant...</option>';
    attendees.forEach(p => {
        if(role === 'All' || p.role.includes(role)) {
            const o = document.createElement('option'); o.value = p.name; o.textContent = p.name; dd.appendChild(o);
        }
    });
}

function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
function showFullscreenStats() { document.getElementById('statsOverlay').style.display = 'flex'; updateStats(); }
function closeStats() { document.getElementById('statsOverlay').style.display = 'none'; }
function resetIdleTimer() { clearTimeout(idleTimer); idleTimer = setTimeout(() => { if(document.getElementById('regModal').style.display !== 'flex') startFlow(); }, 120000); }

function startFlow() { 
    document.getElementById('flowOverlay').style.display = 'block'; 
    const scroller = document.getElementById('scroller'); 
    scrollPos = window.innerHeight; 
    function move() { 
        scrollPos -= 1.5; 
        scroller.style.top = scrollPos + 'px'; 
        if (scrollPos < -scroller.offsetHeight) scrollPos = window.innerHeight; 
        animId = requestAnimationFrame(move); 
    } 
    move(); 
}

function stopFlow() { document.getElementById('flowOverlay').style.display = 'none'; cancelAnimationFrame(animId); resetIdleTimer(); }

document.addEventListener('keydown', (e) => {
    if (e.key === "Escape") {
        stopFlow();
        closeStats();
        closeModal();
    }
});

function toggleGeoFence() { isGeoFenceEnabled = !isGeoFenceEnabled; document.getElementById('geoBtn').textContent = isGeoFenceEnabled ? "üìç Location: ON" : "üìç Location: OFF"; }
function handleCurtainClick() { document.getElementById('qrCurtain').classList.toggle('open'); }
function closeModal() { document.getElementById('regModal').style.display='none'; clearInterval(qrExpiryInterval); }
function openCertLink() { window.open('4th Symposium Certificates.html'); }
function downloadReport() { let csv = "Name,Role,Status\n"; attendees.forEach(p => csv += `"${p.name}","${p.role}","${p.status}"\n`); window.open(URL.createObjectURL(new Blob([csv], {type:'text/csv'}))); }

document.getElementById('combinedDropdown').onchange = (e) => selectUserByName(e.target.value);
window.onload = () => { initChart(); filterRole('All'); updateStats(); modalQR.append(document.getElementById("regModalQR")); resetIdleTimer(); };
</script>
</body>
</html>