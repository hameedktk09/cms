<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4th International Symposium 2026 - Admin Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

<style>
:root {
  --primary: #4361ee; --secondary: #7209b7; --success: #10b981;
  --danger: #f72585; --dark: #212529; --gray: #6c757d;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --curtain-main: #3d5a80;   
  --curtain-shadow: #293241; 
  --curtain-light: #4e6e96;  
}

body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; font-size: 13px;
}

.container {
  width: 98%; max-width: 1200px; background: white; border-radius: 8px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.50); display: flex; flex-direction: column;
}

.header { padding: 6px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; }
.header-left { display: flex; align-items: center; gap: 15px; }
.banner-img { height: 100px; } 

#flowOverlay, #statsOverlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: white; z-index: 9999; display: none; overflow: hidden;
}
#statsOverlay { background: #f8fafc; padding: 40px; box-sizing: border-box; flex-direction: column; align-items: center; justify-content: center; display: none; }

.flow-content { width: 100%; position: absolute; top: -100%; }
.close-flow { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: var(--danger); color: white; border: none; cursor: pointer; z-index: 10000; border-radius: 5px; font-weight: bold; }

.status-indicator { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: bold; padding: 4px 10px; border-radius: 20px; background: #f1f5f9; }
.dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
.dot-online { background-color: var(--success); box-shadow: 0 0 8px var(--success); }
.dot-offline { background-color: var(--danger); }
.dot-sync { background-color: orange; box-shadow: 0 0 6px orange; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000; }
.modal-content { background: white; padding: 25px; border-radius: 15px; text-align: center; max-width: 500px; width: 90%; }
.modal-qr-container { width: 320px; height: 320px; margin: 0 auto 15px auto; transition: 0.5s; transform: scale(0); opacity:0; }
.modal-qr-container.active { transform: scale(1); opacity:1; }

.controls { padding: 6px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
.controls-grid { display: grid; grid-template-columns: 1fr 1.2fr 1.2fr; gap: 15px; align-items: start; }
.btn-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 4px; }

.btn { padding: 7px 10px; border-radius: 5px; border: 1px solid #d1d5db; font-weight: 600; cursor: pointer; transition: 0.15s; font-size: 11px; }
.btn-primary { background: var(--primary); color: white; border: none; }
.btn-sync { background: var(--secondary); color: white; border: none; }
.btn-success { background: var(--success); color: white; border: none; }
.btn-danger { background: var(--danger); color: white; border: none; }
.btn-flow { background: #ff9f43; color: white; border: none; }

.dual-guest-group { display: flex; margin-top: 4px; }
.btn-guest-main { flex: 1; border-radius: 5px 0 0 5px; background: var(--primary); color: white; border: none; }
.btn-guest-arrow { width: 40px; border-radius: 0 5px 5px 0; background: #3046bc; color: white; border: none; border-left: 1px solid rgba(255,255,255,0.2); }
.guest-grid { display: none; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 6px; background: #eef2ff; padding: 8px; border-radius: 5px; border: 1px solid #d0d7f7; }
.btn-mini { padding: 6px; font-size: 9px; text-transform: uppercase; background: white; border: 1px solid var(--primary); color: var(--primary); border-radius: 3px; cursor: pointer; font-weight: bold; }
.btn-mini:hover { background: var(--primary); color: white; }

.main-content { display: grid; grid-template-columns: 1.4fr 0.6fr; gap: 10px; padding: 10px 20px; }
.panel { background: white; padding: 12px 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: var(--shadow); position: relative;}
.display-name { color: var(--primary); font-weight: 600; font-size: 1.1rem; border: 1px solid #eee; padding: 4px 10px; min-width: 250px; display: inline-block; }

.qr-frame { width: 220px; height: 220px; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; background: white; position: relative; overflow: hidden; cursor: pointer; }
.qr-curtain { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, var(--curtain-shadow) 0%, var(--curtain-main) 30%, var(--curtain-light) 50%, var(--curtain-main) 70%, var(--curtain-shadow) 100%); background-size: 40px 100%; transition: transform 0.6s; z-index: 10; transform-origin: top; }
.qr-curtain.open { transform: scaleY(0); }

.info-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.info-item { background: #f9fafb; padding: 8px 10px; border-radius: 6px; border: 1px solid #eee; }
footer { padding: 6px; text-align: center; font-size: 10px; color: var(--gray); border-top: 1px solid #f1f5f9; }
input[type="text"], select { width: 100%; padding: 7px; border-radius: 5px; border: 1px solid #ccc; font-size: 13px; }

.stats-grid p { margin: 3px 0; display: flex; justify-content: space-between; font-size: 11px; }

.fs-stats-card { background: white; border-radius: 20px; padding: 40px; width: 90%; max-width: 1100px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); text-align: center; }
.fs-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 30px; }
.fs-val { font-size: 2.2rem; font-weight: 800; color: var(--primary); display: block; }
.fs-label { color: var(--gray); text-transform: uppercase; font-size: 9px; letter-spacing: 1px; }

.header-count-badge { background: var(--success); color: white; padding: 4px 12px; border-radius: 50px; font-size: 1.2rem; margin-left: 10px; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
.header-rate-badge { background: var(--dark); color: white; padding: 4px 12px; border-radius: 50px; font-size: 1.2rem; margin-left: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); }
</style>
</head>
<body>

<div id="flowOverlay">
    <button class="close-flow" onclick="stopFlow()">‚úñ Close Animation</button>
    <div id="scroller" class="flow-content" style="height: 2000px;">
        <iframe src="4th Symposium Program Flow.pdf" style="width:100%; height:100%; border:none;"></iframe>
    </div>
</div>

<div id="statsOverlay">
    <button class="close-flow" onclick="closeStats()">‚úñ Close Statistics</button>
    <div class="fs-stats-card">
        <h1 style="color:var(--primary); margin-top:0; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px;">
            Live Attendance Analytics 
            <span class="header-count-badge" id="fsHeaderPresent">0</span>
            <span class="header-rate-badge" id="fsHeaderRate">0%</span>
        </h1>
        <div style="height: 380px; width: 100%; margin: 20px 0;">
            <canvas id="fsStatChart"></canvas>
        </div>
        <div class="fs-grid">
            <div><span class="fs-val" id="fsTotal">0</span><span class="fs-label">Total Base</span></div>
            <div><span class="fs-val" id="fsPresent" style="color:var(--success)">0</span><span class="fs-label">Total Present</span></div>
            <div><span class="fs-val" id="fsStudent" style="color:#00b4d8">0</span><span class="fs-label">ASU Students</span></div>
            <div><span class="fs-val" id="fsStaff" style="color:#f39c12">0</span><span class="fs-label">ASU Staff</span></div>
            <div><span class="fs-val" id="fsOnsite" style="color:var(--danger)">0</span><span class="fs-label">On-Site New</span></div>
            <div><span class="fs-val" id="fsGuestStat" style="color:var(--secondary)">0</span><span class="fs-label">VIP Guests</span></div>
            <div><span class="fs-val" id="fsRate" style="color:var(--dark)">0%</span><span class="fs-label">Presence Rate</span></div>
        </div>
    </div>
</div>

<div class="container" id="mainDashboard">
  <div class="header">
    <div class="header-left">
        <img src="Certi-logo.png" class="banner-img" alt="ASU Banner">
        <div>
            <h2 style="margin:0; font-size:1.3rem; color:var(--primary);">4th International Symposium 2026</h2>
            <p style="margin:0; color:var(--gray); font-size: 12px;">Admin Face-to-Face Dashboard</p>
        </div>
    </div>
    <div style="display: flex; gap: 5px; align-items: center;">
        <button class="btn btn-flow" onclick="toggleFullScreen()" style="background:#2d3436; color:white;">‚õ∂ Fullscreen</button>
        <button class="btn btn-flow" onclick="startFlow()">‚ñ∂ Play Flow</button>
        <button class="btn btn-geo" id="geoBtn" onclick="toggleGeoFence()">üìç Location: OFF</button>
        <div class="status-indicator" style="margin-left:8px;">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">READY</span>
        </div>
    </div>
  </div>

  <div class="controls">
    <div class="controls-grid">
      <div>
        <label style="font-size:10px; font-weight:bold; color: var(--gray);">FILTERS</label>
        <div class="btn-pair">
            <button class="btn btn-primary" onclick="filterRole('All')">All</button>
            <button class="btn btn-primary" onclick="filterRole('Participant')">Attendees</button>
        </div>
        <div class="btn-pair">
            <button class="btn btn-primary" onclick="filterRole('Organiser')">Organisers</button>
            <button class="btn btn-primary" onclick="filterRole('Speaker')">Speakers</button>
        </div>
      </div>

      <div>
        <label style="font-size:10px; font-weight:bold; color: var(--gray);">MANAGEMENT</label>
        <div class="btn-pair" style="grid-template-columns: 1fr;">
            <button class="btn btn-sync" id="syncBtn" onclick="handleDataAction()">üìÇ Sync Cloud & ‚¨ÜÔ∏è Upload CSV</button>
            <input type="file" id="uploadFiles" style="display:none" accept=".csv" multiple onchange="handleFileUpload(this)">
        </div>
        
        <div class="dual-guest-group">
            <button class="btn btn-guest-main" onclick="filterRole('Guest')">üë§ Guest List</button>
            <button class="btn btn-guest-arrow" onclick="toggleGuestPanel()">‚ñº</button>
        </div>

        <div id="guestPanel" class="guest-grid">
            <button class="btn-mini" onclick="quickAddGuest('Ministers/VIP')">Min./VIP</button>
            <button class="btn-mini" onclick="quickAddGuest('BoT/BoD')">BoT/BoD</button>
            <button class="btn-mini" onclick="quickAddGuest('VC/DVC/DVCAAR')">VC/DVCs</button>
            <button class="btn-mini" onclick="quickAddGuest('Deans/Directors')">Deans/Dir</button>
            <button class="btn-mini" onclick="quickAddGuest('ASU Staff')">ASU Staff</button>
            <button class="btn-mini" onclick="quickAddGuest('ASU Students')">ASU Students</button>
            <button class="btn-mini" onclick="quickAddGuest('Friends/Relatives')">Friends/Rel</button>
            <button class="btn-mini" style="background:#f1f5f9; grid-column: span 2;" onclick="customGuest()">Custom Guest+</button>
        </div>
      </div>

      <div>
        <label style="font-size:10px; font-weight:bold; color: var(--gray);">SEARCH & QR ACCESS</label>
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 4px;">
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <button class="btn" style="background:#3a0ca3; color:white; padding: 7px 5px;" onclick="showSecureQR('PRE-REG')">üì± Pre-Reg</button>
                <button class="btn" style="background:linear-gradient(to right, #f72585, #4361ee); color:white; padding: 7px 5px;" onclick="showSecureQR('ON-SITE')">üì± On-Site</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <input type="text" id="searchBox" placeholder="üîç Search name..." onkeyup="handleSearch(this.value)">
                <select id="combinedDropdown"><option value="">Select Participant...</option></select>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="panel">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
          <button class="btn btn-success" style="padding: 10px 18px;" id="btnMarkPresent" onclick="togglePresence()">‚òë Mark Present</button>
          <span class="display-name" id="displayName">No Selection</span>
        </div>
        <div style="display:flex; gap:20px; align-items:flex-start;">
          <div class="qr-frame" onclick="handleCurtainClick()">
              <div id="qrCurtain" class="qr-curtain"></div>
              <img id="mainQrImg" src="4th Symposium Check-in QR.png" style="width:100%">
          </div>
          <div class="info-grid">
            <div class="info-item"><b>Status</b><div id="valStatus" style="font-weight:bold; color:var(--danger);">-</div></div>
            <div class="info-item"><b>Category</b><div id="valCategory">-</div></div>
            <div class="info-item" style="grid-column: span 2;"><b>Institution</b><div id="valInstitution">-</div></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; grid-column: span 2;">
                <button class="btn" style="background:#2d3436; color:white" onclick="downloadReport()">üìÑ Report</button>
                <button class="btn" style="background:#1a3a82; color:white" onclick="openCertLink()">üéì E-Certs</button>
            </div>
          </div>
        </div>
    </div>
    
    <div class="panel">
      <h4 style="margin:0 0 5px 0; color: var(--secondary); border-bottom: 2px solid #eee; padding-bottom: 3px;">üìä Symposium Statistics</h4>
      <div id="statsContainer">
          <div style="height: 100px; margin-bottom: 10px;">
              <canvas id="statChart"></canvas>
          </div>
          <div class="stats-grid">
              <p>Pre-registered: <b id="statPreReg">0</b></p>
              <p>On-Site (New): <b id="statNew">0</b></p>
              <p>ASU Students: <b id="statStudents">0</b></p>
              <p>ASU Staff: <b id="statStaff">0</b></p>
              <p>VIP Guests: <b id="statGuests">0</b></p>
              <hr style="border:0; border-top:1px solid #f1f1f1; margin: 4px 0;">
              <p>Total Present: <b id="statTotalPres" style="color:var(--success)">0</b></p>
          </div>
          <div style="text-align: center; margin-top: 5px;">
              <div id="statTotalPerc" style="font-size: 24px; font-weight: bold; color: var(--primary);">0%</div>
              <span style="font-size: 9px; color: var(--gray);">ATTENDANCE RATE</span>
          </div>
          <button class="btn btn-primary" style="width:100%; margin-top:10px; background:var(--secondary);" onclick="showFullscreenStats()">üìä Full Screen Stats</button>
      </div>
    </div>
  </div>
  <footer>A'Sharqiyah University, Ibra, Oman. Copyright &copy; drkhan 2026.</footer>
</div>

<div id="regModal" class="modal-overlay">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="modalTitle" style="color:var(--primary); margin-bottom:5px;">Registration</h2>
        <p id="modalAttendee" style="font-weight:bold; color:var(--gray); margin-bottom:15px;"></p>
        <div id="regModalQR" class="modal-qr-container"></div>
        <div style="background: #fff5f5; padding: 10px; border-radius: 8px;">
            <span style="font-size: 10px; color: #c53030; text-transform: uppercase;">Time Remaining</span>
            <div id="expiryTimer" style="color:var(--danger); font-size: 22px; font-weight:bold; font-family: monospace;">05:00</div>
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:15px; padding:10px;" onclick="closeModal()">Close</button>
    </div>
</div>

<script>
let attendees = JSON.parse(localStorage.getItem('asuDashboardAttendees')) || [];
let currentIdx = -1, isGeoFenceEnabled = false;
let qrExpiryInterval, idleTimer, animId;
let scrollPos = -2000, myChart, fsChart;

// Dynamic High-Contrast Single Solid Colors (No Gradients)
function getDynamicQRStyle() {
    const contrastColors = ["#000000", "#064e3b", "#1e3a8a", "#991b1b", "#451a03"];
    const pick = contrastColors[Math.floor(Math.random() * contrastColors.length)];
    return {
        dotsOptions: { type: "extra-rounded", color: pick, gradient: null },
        cornersSquareOptions: { type: "extra-rounded", color: pick },
        cornersDotOptions: { type: "dot", color: pick }
    };
}

const modalQR = new QRCodeStyling({ width: 320, height: 320, backgroundOptions: { color: "#ffffff" } });

function initChart() {
    const ctx = document.getElementById('statChart').getContext('2d');
    const fsCtx = document.getElementById('fsStatChart').getContext('2d');
    const commonOptions = {
        maintainAspectRatio: false,
        animation: { duration: 1500, easing: 'easeOutQuart', y: { from: (ctx) => ctx.chart.scales.y.getPixelForValue(0) } },
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, display: true, ticks: { precision: 0 } }, x: { grid: { display: false } } }
    };
    const commonData = {
        labels: ['Total', 'Present', 'Student', 'Staff', 'On-Site', 'VIP'],
        datasets: [{ label: 'Count', data: [0, 0, 0, 0, 0, 0], backgroundColor: ['#4361ee', '#10b981', '#00b4d8', '#f39c12', '#f72585', '#7209b7'], borderRadius: 6 }]
    };
    myChart = new Chart(ctx, { type: 'bar', data: JSON.parse(JSON.stringify(commonData)), options: commonOptions });
    fsChart = new Chart(fsCtx, { type: 'bar', data: JSON.parse(JSON.stringify(commonData)), options: commonOptions });
}

function updateStats() {
    const totalBase = attendees.length;
    const present = attendees.filter(p => p.status.includes('‚úÖ')).length;
    const students = attendees.filter(p => p.role.includes('ASU Students')).length;
    const staff = attendees.filter(p => p.role.includes('ASU Staff')).length;
    const onsite = attendees.filter(p => p.role.includes('(New)')).length;
    const guests = attendees.filter(p => p.role.includes('Guest') && !p.role.includes('ASU')).length;
    const rate = (totalBase > 0 ? (present/totalBase*100).toFixed(1) : 0) + "%";

    // Dashboard Updates
    document.getElementById('statPreReg').textContent = totalBase - onsite - students - staff - guests;
    document.getElementById('statNew').textContent = onsite;
    document.getElementById('statStudents').textContent = students;
    document.getElementById('statStaff').textContent = staff;
    document.getElementById('statGuests').textContent = guests;
    document.getElementById('statTotalPres').textContent = present;
    document.getElementById('statTotalPerc').textContent = rate;

    // Full Screen Updates
    document.getElementById('fsTotal').textContent = totalBase;
    document.getElementById('fsPresent').textContent = present;
    document.getElementById('fsStudent').textContent = students;
    document.getElementById('fsStaff').textContent = staff;
    document.getElementById('fsOnsite').textContent = onsite;
    document.getElementById('fsGuestStat').textContent = guests;
    document.getElementById('fsRate').textContent = rate;
    document.getElementById('fsHeaderPresent').textContent = present;
    document.getElementById('fsHeaderRate').textContent = rate;

    const chartData = [totalBase, present, students, staff, onsite, guests];
    if(myChart) { myChart.data.datasets[0].data = chartData; myChart.update(); }
    if(fsChart) { fsChart.data.datasets[0].data = chartData; fsChart.update(); }
}

function handleDataAction() { if (confirm("Sync from GitHub Cloud?")) syncAll(); else document.getElementById('uploadFiles').click(); }
function toggleGuestPanel() { const panel = document.getElementById('guestPanel'); panel.style.display = panel.style.display === 'grid' ? 'none' : 'grid'; }

function quickAddGuest(roleGroup) {
    const guestName = `${roleGroup} ${(attendees.filter(a => a.name.startsWith(roleGroup)).length + 1).toString().padStart(2, '0')}`;
    const newGuest = { name: guestName, status: "‚úÖ Present", institute: "ASU", role: "Guest (" + roleGroup + ")" };
    attendees.push(newGuest);
    localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
    filterRole('All'); updateStats(); selectUserByName(guestName);
}

function customGuest() { const cat = prompt("Enter Custom Category:"); if(cat) quickAddGuest(cat.trim()); }

async function syncAll() {
    const dot = document.getElementById('statusDot');
    dot.className = 'dot dot-sync';
    const baseUrl = "https://raw.githubusercontent.com/hameedktk09/cms/main/";
    const files = [
        { name: "4th Symposium 2026 Participants.csv", role: "Participant" },
        { name: "4th Symposium 2026 On-Site Participants.csv", role: "Participant (New)" },
        { name: "4th Symposium 2026 Organisers.csv", role: "Organiser" },
        { name: "4th Symposium 2026 Speakers.csv", role: "Speaker" }
    ];
    try {
        for (let file of files) {
            const response = await fetch(baseUrl + encodeURIComponent(file.name));
            if (response.ok) processSyncData(await response.text(), file.role);
        }
        localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
        filterRole('All'); updateStats(); dot.className = 'dot dot-online'; alert("Sync Successful!");
    } catch (e) { dot.className = 'dot dot-offline'; }
}

function processSyncData(csvText, assignedRole) {
    const rows = csvText.split('\n');
    rows.slice(1).forEach(row => {
        const cols = row.split(',');
        if (cols.length > 4) {
            const name = cols[4].trim();
            if (!attendees.find(a => a.name === name)) {
                attendees.push({ name: name, status: "‚ùå Pending", institute: cols[7] ? cols[7].trim() : "ASU", role: assignedRole });
            }
        }
    });
}

function handleFileUpload(input) {
    Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            let r = file.name.toLowerCase().includes("speaker") ? "Speaker" : (file.name.toLowerCase().includes("organiser") ? "Organiser" : "Participant");
            processSyncData(e.target.result, r);
            localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
            filterRole('All'); updateStats();
        };
        reader.readAsText(file);
    });
}

function showSecureQR(type) {
    const modal = document.getElementById('regModal');
    let qrData = "";
    if(type === 'PRE-REG') {
        if(currentIdx === -1) return alert("Select participant first!");
        document.getElementById('modalAttendee').textContent = "Name: " + attendees[currentIdx].name;
        qrData = "https://forms.gle/izxwf4pbgJb1UXhTA?id=" + encodeURIComponent(attendees[currentIdx].name);
    } else {
        document.getElementById('modalAttendee').textContent = "NEW ON-SITE REGISTRATION";
        qrData = "https://forms.gle/FtuEVmusMqCerHqC7";
    }
    document.getElementById('modalTitle').textContent = type + " REGISTRATION";
    modal.style.display = 'flex';
    modalQR.update(getDynamicQRStyle());
    clearInterval(qrExpiryInterval);
    let timeLeft = 300;
    qrExpiryInterval = setInterval(() => {
        timeLeft--;
        let m = Math.floor(timeLeft/60), s = timeLeft%60;
        document.getElementById('expiryTimer').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if(timeLeft <= 0) closeModal();
    }, 1000);
    setTimeout(() => {
        modalQR.update({ data: qrData });
        document.getElementById('regModalQR').classList.add('active');
    }, 150);
}

function togglePresence() {
    if(currentIdx === -1) return;
    let p = attendees[currentIdx];
    p.status = p.status.includes('‚úÖ') ? "‚ùå Pending" : "‚úÖ Present";
    localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
    selectUserByName(p.name);
    updateStats();
}

function selectUserByName(name) {
    const p = attendees.find(u => u.name === name);
    if(!p) return;
    currentIdx = attendees.indexOf(p);
    document.getElementById('displayName').textContent = p.name;
    document.getElementById('valStatus').textContent = p.status;
    document.getElementById('valStatus').style.color = p.status.includes('‚úÖ') ? '#10b981' : '#f72585';
    document.getElementById('btnMarkPresent').textContent = p.status.includes('‚úÖ') ? "‚òí Mark Un-Present" : "‚òë Mark Present";
    document.getElementById('btnMarkPresent').className = p.status.includes('‚úÖ') ? "btn btn-danger" : "btn btn-success";
    document.getElementById('valInstitution').textContent = p.institute;
    document.getElementById('valCategory').textContent = p.role;
    document.getElementById('combinedDropdown').value = p.name;
}

function handleSearch(val) {
    const filtered = attendees.filter(p => p.name.toLowerCase().includes(val.toLowerCase()));
    if(filtered.length > 0) selectUserByName(filtered[0].name);
}

function filterRole(role) {
    const dd = document.getElementById('combinedDropdown');
    dd.innerHTML = '<option value="">Select Participant...</option>';
    attendees.forEach(p => {
        if(role === 'All' || p.role.includes(role)) {
            const o = document.createElement('option');
            o.value = p.name; o.textContent = p.name; dd.appendChild(o);
        }
    });
}

function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
function showFullscreenStats() { document.getElementById('statsOverlay').style.display = 'flex'; updateStats(); }
function closeStats() { document.getElementById('statsOverlay').style.display = 'none'; }
function resetIdleTimer() { if(document.getElementById('flowOverlay').style.display === 'block') stopFlow(); clearTimeout(idleTimer); idleTimer = setTimeout(() => { if(document.getElementById('regModal').style.display !== 'flex' && document.getElementById('statsOverlay').style.display !== 'flex') startFlow(); }, 120000); }
function startFlow() { document.getElementById('flowOverlay').style.display = 'block'; const scroller = document.getElementById('scroller'); scrollPos = -scroller.offsetHeight; function move() { scrollPos += 3; scroller.style.top = scrollPos + 'px'; if (scrollPos > window.innerHeight) scrollPos = -scroller.offsetHeight; animId = requestAnimationFrame(move); } move(); }
function stopFlow() { document.getElementById('flowOverlay').style.display = 'none'; cancelAnimationFrame(animId); resetIdleTimer(); }
function toggleGeoFence() { isGeoFenceEnabled = !isGeoFenceEnabled; document.getElementById('geoBtn').textContent = isGeoFenceEnabled ? "üìç Location: ON" : "üìç Location: OFF"; document.getElementById('geoBtn').style.background = isGeoFenceEnabled ? "#10b981" : "#636e72"; }
function handleCurtainClick() { if(!isGeoFenceEnabled) return document.getElementById('qrCurtain').classList.toggle('open'); navigator.geolocation.getCurrentPosition(() => document.getElementById('qrCurtain').classList.add('open')); }
function closeModal() { document.getElementById('regModal').style.display='none'; clearInterval(qrExpiryInterval); }
function openCertLink() { window.open('4th Symposium Certificates.html'); }
function downloadReport() { let csv = "Name,Category,Institution,Status\n"; attendees.forEach(p => { csv += `"${p.name}","${p.role}","${p.institute}","${p.status}"\n`; }); window.open(URL.createObjectURL(new Blob([csv], { type: 'text/csv' }))); }

document.getElementById('combinedDropdown').onchange = (e) => selectUserByName(e.target.value);
['mousedown', 'mousemove', 'keypress', 'touchstart'].forEach(evt => window.addEventListener(evt, resetIdleTimer, true));

window.onload = () => { initChart(); filterRole('All'); updateStats(); modalQR.append(document.getElementById("regModalQR")); resetIdleTimer(); };
</script>
</body>
</html>