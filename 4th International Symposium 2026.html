<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4th International Symposium 2026 - Admin Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

<style>
:root {
  --primary: #4361ee; --secondary: #7209b7; --success: #10b981;
  --danger: #f72585; --dark: #212529; --gray: #6c757d;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --curtain-main: #3d5a80;   
  --curtain-shadow: #293241; 
  --curtain-light: #4e6e96;  
}

body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; font-size: 13px;
}

.container {
  width: 98%; max-width: 1200px; background: white; border-radius: 8px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.50); display: flex; flex-direction: column;
}

.header { padding: 6px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; }
.header-left { display: flex; align-items: center; gap: 15px; }
.banner-img { height: 100px; } 

.status-indicator { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: bold; padding: 4px 10px; border-radius: 20px; background: #f1f5f9; }
.dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
.dot-online { background-color: var(--success); box-shadow: 0 0 8px var(--success); }
.dot-offline { background-color: var(--danger); }
.dot-sync { background-color: orange; box-shadow: 0 0 6px orange; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000; }
.modal-content { background: white; padding: 25px; border-radius: 15px; text-align: center; max-width: 500px; width: 90%; }
.modal-qr-container { width: 320px; height: 320px; margin: 0 auto 15px auto; transition: 0.5s; transform: scale(0); opacity:0; }
.modal-qr-container.active { transform: scale(1); opacity:1; }

#programFlowOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; z-index: 4000; overflow: hidden; }
.close-flow { position: fixed; top: 20px; right: 20px; z-index: 4001; padding: 10px 20px; background: var(--danger); color: white; border: none; cursor: pointer; border-radius: 5px; }

.controls { padding: 6px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
.controls-grid { display: grid; grid-template-columns: 1fr 0.8fr 1.5fr; gap: 15px; align-items: start; }
.btn-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 4px; }

.btn { padding: 7px 10px; border-radius: 5px; border: 1px solid #d1d5db; font-weight: 600; cursor: pointer; transition: 0.15s; font-size: 12px; }
.btn-primary { background: var(--primary); color: white; border: none; }
.btn-sync { background: var(--secondary); color: white; border: none; }
.btn-success { background: var(--success); color: white; border: none; }
.btn-danger { background: var(--danger); color: white; border: none; }
.btn-flow { background: #ff9f43; color: white; border: none; }

.main-content { display: grid; grid-template-columns: 1.4fr 0.6fr; gap: 10px; padding: 10px 20px; }
.panel { background: white; padding: 12px 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: var(--shadow); position: relative;}
.display-name { color: var(--primary); font-weight: 600; font-size: 1.1rem; border: 1px solid #eee; padding: 4px 10px; min-width: 250px; display: inline-block; }

.qr-frame { width: 220px; height: 220px; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; background: white; position: relative; overflow: hidden; cursor: pointer; }
.qr-curtain { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, var(--curtain-shadow) 0%, var(--curtain-main) 30%, var(--curtain-light) 50%, var(--curtain-main) 70%, var(--curtain-shadow) 100%); background-size: 40px 100%; transition: transform 0.6s; z-index: 10; transform-origin: top; }
.qr-curtain.open { transform: scaleY(0); }

.info-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.info-item { background: #f9fafb; padding: 8px 10px; border-radius: 6px; border: 1px solid #eee; }
footer { padding: 6px; text-align: center; font-size: 10px; color: var(--gray); border-top: 1px solid #f1f5f9; }
input[type="text"], select { width: 100%; padding: 7px; border-radius: 5px; border: 1px solid #ccc; font-size: 13px; }

.stats-grid p { margin: 3px 0; display: flex; justify-content: space-between; font-size: 11px; }
</style>
</head>
<body>

<div id="programFlowOverlay">
    <div style="position: fixed; top: 10px; left: 20px; color: white; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; font-size: 11px; z-index: 4002;">Auto-Scroll Active | Move mouse to exit</div>
    <button class="close-flow" onclick="stopRollingFlow()">‚úñ Stop Rolling</button>
    <iframe id="flowIframe" src="D:/Symposium-4 CLFS/4th Symposium Program Flow.pdf" style="width:100%; height:100%; border:none;"></iframe>
</div>

<div class="container" id="mainDashboard">
  <div class="header">
    <div class="header-left">
        <img src="Symposium Banner.png" class="banner-img" alt="ASU Banner">
        <div>
            <h2 style="margin:0; font-size:1.3rem; color:var(--primary);">4th International Symposium 2026</h2>
            <p style="margin:0; color:var(--gray); font-size: 12px;">Admin Face-to-Face Dashboard</p>
        </div>
    </div>
    <div style="display: flex; gap: 5px; align-items: center;">
        <button class="btn btn-flow" onclick="toggleFullScreen()" style="background:#2d3436; color:white;">‚õ∂ Fullscreen</button>
        <button class="btn btn-flow" onclick="startRollingFlow()">‚ñ∂ Play Flow</button>
        <button class="btn btn-geo" id="geoBtn" onclick="toggleGeoFence()">üìç Location: OFF</button>
        <div class="status-indicator" style="margin-left:8px;">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">READY</span>
        </div>
    </div>
  </div>

  <div class="controls">
    <div class="controls-grid">
      <div>
        <label style="font-size:10px; font-weight:bold; color: var(--gray);">FILTERS</label>
        <div class="btn-pair">
            <button class="btn btn-primary" onclick="filterRole('All')">All</button>
            <button class="btn btn-primary" onclick="filterRole('Participant')">Attendees</button>
        </div>
        <div class="btn-pair">
            <button class="btn btn-primary" onclick="filterRole('Organiser')">Organisers</button>
            <button class="btn btn-primary" onclick="filterRole('Speaker')">Speakers</button>
        </div>
      </div>

      <div>
        <label style="font-size:10px; font-weight:bold; color: var(--gray);">DATA</label>
        <div class="btn-pair" style="grid-template-columns: 1fr;"><button class="btn btn-sync" id="syncBtn" onclick="syncAll()">üìÇ Sync Cloud Data</button></div>
        <div class="btn-pair" style="grid-template-columns: 1fr;">
            <input type="file" id="uploadFiles" style="display:none" accept=".csv" multiple onchange="handleFileUpload(this)">
            <button class="btn btn-primary" onclick="document.getElementById('uploadFiles').click()">‚¨ÜÔ∏è Upload CSV</button>
        </div>
      </div>

      <div>
        <label style="font-size:10px; font-weight:bold; color: var(--gray);">SEARCH & ACCESS</label>
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 4px;">
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <button class="btn" style="background:#3a0ca3; color:white; padding: 7px 5px;" onclick="showSecureQR('PRE-REG')">üì± Pre-Reg</button>
                <button class="btn" style="background:linear-gradient(to right, #f72585, #4361ee); color:white; padding: 7px 5px;" onclick="showSecureQR('ON-SITE')">üì± On-Site</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <input type="text" id="searchBox" placeholder="üîç Search name..." style="padding: 6px;" onkeyup="handleSearch(this.value)">
                <select id="combinedDropdown"><option value="">Select Participant...</option></select>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="panel">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
          <button class="btn btn-success" style="padding: 10px 18px;" id="btnMarkPresent" onclick="togglePresence()">‚òë Mark Present</button>
          <span class="display-name" id="displayName">No Selection</span>
        </div>
        <div style="display:flex; gap:20px; align-items:flex-start;">
          <div class="qr-frame" onclick="handleCurtainClick()">
              <div id="qrCurtain" class="qr-curtain"></div>
              <img id="mainQrImg" src="4th Symposium Check-in QR.png" style="width:100%">
          </div>
          <div class="info-grid">
            <div class="info-item"><b>Status</b><div id="valStatus" style="font-weight:bold; color:var(--danger);">-</div></div>
            <div class="info-item"><b>Category</b><div id="valCategory">-</div></div>
            <div class="info-item" style="grid-column: span 2;"><b>Institution</b><div id="valInstitution">-</div></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; grid-column: span 2;">
                <button class="btn" style="background:#2d3436; color:white" onclick="downloadReport()">üìÑ Report</button>
                <button class="btn" style="background:#1a3a82; color:white" onclick="openCertLink()">üéì E-Certs</button>
            </div>
          </div>
        </div>
    </div>
    
    <div class="panel">
      <h4 style="margin:0 0 5px 0; color: var(--secondary); border-bottom: 2px solid #eee; padding-bottom: 3px;">üìä Symposium Statistics Analysis</h4>
      <div id="statsContainer">
          <div style="height: 100px; margin-bottom: 10px;">
              <canvas id="statChart"></canvas>
          </div>
          <div class="stats-grid">
              <p>Pre-registered: <b id="statPreReg">0</b></p>
              <p>Pre-Reg. Attendance: <b id="statPreAtt">0</b></p>
              <p>Pre-Reg. %: <b id="statPrePerc">0%</b></p>
              <p style="background:#f0f4ff; padding: 2px 4px; border-radius: 3px;">New Participants (On-Site): <b id="statNew" style="color:var(--primary)">0</b></p>
              <hr style="border:0; border-top:1px solid #f1f1f1; margin: 4px 0;">
              <p>Speakers: <b id="statSpeakers">0</b></p>
              <p>Organisers: <b id="statOrg">0</b></p>
              <p>Total Present: <b id="statTotalPres" style="color:var(--success)">0</b></p>
          </div>
          <div style="text-align: center; margin-top: 5px; padding-top: 5px; border-top: 2px solid #f8fafc;">
              <div id="statTotalPerc" style="font-size: 24px; font-weight: bold; color: var(--primary);">0%</div>
              <span style="font-size: 9px; color: var(--gray); text-transform: uppercase;">Total Attendance Rate</span>
          </div>
      </div>
    </div>
  </div>
  <footer>A'Sharqiyah University, Ibra, Oman. Copyright &copy; drkhan 2026.</footer>
</div>

<div id="regModal" class="modal-overlay">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="modalTitle" style="color:var(--primary); margin-bottom:5px;">Registration</h2>
        <p id="modalAttendee" style="font-weight:bold; color:var(--gray); margin-bottom:15px;"></p>
        <div id="regModalQR" class="modal-qr-container"></div>
        <div style="background: #fff5f5; padding: 10px; border-radius: 8px;">
            <span style="font-size: 10px; color: #c53030; text-transform: uppercase;">Time Remaining</span>
            <div id="expiryTimer" style="color:var(--danger); font-size: 22px; font-weight:bold; font-family: monospace;">05:00</div>
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:15px; padding:10px;" onclick="closeModal()">Close</button>
    </div>
</div>

<script>
let attendees = JSON.parse(localStorage.getItem('asuDashboardAttendees')) || [];
let currentIdx = -1, rollingInterval, isGeoFenceEnabled = false;
let qrExpiryInterval, idleTimer;
let scrollPos = 0, myChart;

const modalQR = new QRCodeStyling({
    width: 320, height: 320,
    dotsOptions: { type: "square" },
    cornersSquareOptions: { type: "square", color: "#000" },
    backgroundOptions: { color: "#fff" }
});

function initChart() {
    const ctx = document.getElementById('statChart').getContext('2d');
    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Pre-Reg', 'Present', 'On-Site'],
            datasets: [{
                label: 'Headcount',
                data: [0, 0, 0],
                backgroundColor: ['#4361ee', '#10b981', '#f72585'],
                borderRadius: 5
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } }
        }
    });
}

function toggleFullScreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else if (document.exitFullscreen) document.exitFullscreen();
}

function resetIdleTimer() {
    if(document.getElementById('programFlowOverlay').style.display === 'block') stopRollingFlow();
    clearTimeout(idleTimer);
    idleTimer = setTimeout(() => {
        if(document.getElementById('regModal').style.display !== 'flex') startRollingFlow();
    }, 120000);
}

['mousedown', 'mousemove', 'keypress', 'touchstart'].forEach(evt => {
    window.addEventListener(evt, resetIdleTimer, true);
});

async function syncAll() {
    const dot = document.getElementById('statusDot');
    dot.className = 'dot dot-sync';
    
    const preRegUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpIqmmrbr2onWAPZN9vyRHSIVuWamRG2fToIh4odfeZCF9s5fnn2gXzKhyFXcoSnKxhP4JPBBdM7_7/pub?gid=1600117244&single=true&output=csv";
    const onSiteUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSHm3hXcQhODrGTNIaAxjGTWwHSxw-KbZ_eZPTcBXyvthjFZcx3Y0aPKntG1dPe1-0j6gyOHCryb8-M/pub?gid=1907106900&single=true&output=csv";

    try {
        const preRegResponse = await fetch(preRegUrl);
        const onSiteResponse = await fetch(onSiteUrl);
        
        const preRegData = await preRegResponse.text();
        const onSiteData = await onSiteResponse.text();

        processSyncData(preRegData, false);
        processSyncData(onSiteData, true);

        localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
        filterRole('All');
        updateStats();
        
        dot.className = 'dot dot-online';
        alert("Sync Successful!");
    } catch (error) {
        console.error("Sync Failed:", error);
        dot.className = 'dot dot-offline';
        alert("Sync failed. Check internet connection.");
    }
}

function processSyncData(csvText, isOnSite) {
    const rows = csvText.split('\n');
    rows.slice(1).forEach(row => {
        const cols = row.split(',');
        if (cols.length > 4) {
            const name = cols[4].trim();
            const institute = cols[7] ? cols[7].trim() : "ASU";
            const role = isOnSite ? "Participant (New)" : "Participant";
            
            // Avoid duplicates
            if (!attendees.find(a => a.name === name)) {
                attendees.push({
                    name: name,
                    status: "‚ùå Pending",
                    institute: institute,
                    role: role
                });
            }
        }
    });
}

function showSecureQR(type) {
    let guestName = "";
    if(type === 'PRE-REG') {
        if(currentIdx === -1) return alert("Select participant first!");
        if(attendees[currentIdx].status.includes('‚úÖ')) return alert("Already Checked-In");
        guestName = attendees[currentIdx].name;
    } else {
        let realNameInput = prompt("Enter Participant Real Name:");
        if (!realNameInput || realNameInput.trim() === "") return;
        guestName = realNameInput.trim();
        
        if (!attendees.find(a => a.name === guestName)) {
            attendees.push({
                name: guestName, 
                status: "‚ùå Pending", 
                institute: "On-Site Registration", 
                role: "Participant (New)" 
            });
            localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
        }
        filterRole('All');
        updateStats();
        selectUserByName(guestName);
    }

    const modal = document.getElementById('regModal');
    const timerDisplay = document.getElementById('expiryTimer');
    
    let baseUrl = (type==='PRE-REG') ? "https://forms.gle/izxwf4pbgJb1UXhTA" : "https://forms.gle/FtuEVmusMqCerHqC7";
    let finalUrl = baseUrl + "?id=" + encodeURIComponent(guestName);

    document.getElementById('modalTitle').textContent = type + " REGISTRATION";
    document.getElementById('modalAttendee').textContent = "Name: " + guestName;
    
    modal.style.display = 'flex';
    document.getElementById('regModalQR').classList.remove('active');

    clearInterval(qrExpiryInterval);
    let timeLeft = 300;
    qrExpiryInterval = setInterval(() => {
        timeLeft--;
        let m = Math.floor(timeLeft/60), s = timeLeft%60;
        timerDisplay.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if(timeLeft <= 0) closeModal();
    }, 1000);

    setTimeout(() => {
        modalQR.update({ data: finalUrl });
        document.getElementById('regModalQR').classList.add('active');
    }, 150);
}

function togglePresence() {
    if(currentIdx === -1) return;
    let p = attendees[currentIdx];
    p.status = p.status.includes('‚úÖ') ? "‚ùå Pending" : "‚úÖ Present";
    localStorage.setItem('asuDashboardAttendees', JSON.stringify(attendees));
    selectUserByName(p.name);
    updateStats();
}

function startRollingFlow() {
    const overlay = document.getElementById('programFlowOverlay');
    overlay.style.display = 'block';
    scrollPos = 0;
    const iframe = document.getElementById('flowIframe');
    clearInterval(rollingInterval);
    rollingInterval = setInterval(() => {
        scrollPos += 2;
        iframe.contentWindow.scroll(0, scrollPos);
        if(scrollPos > 4000) scrollPos = 0;
    }, 50);
}

function stopRollingFlow() {
    document.getElementById('programFlowOverlay').style.display='none';
    clearInterval(rollingInterval);
    resetIdleTimer();
}

function downloadReport() {
    let csv = "Name,Category,Institution,Status\n";
    attendees.forEach(p => { csv += `"${p.name}","${p.role}","${p.institute}","${p.status}"\n`; });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `Symposium_Final_Report.csv`; a.click();
}

function updateStats() {
    const preRegs = attendees.filter(p => !p.role.includes('(New)'));
    const onSite = attendees.filter(p => p.role.includes('(New)'));
    const prePresent = preRegs.filter(p => p.status.includes('‚úÖ')).length;
    const totalPresent = attendees.filter(p => p.status.includes('‚úÖ')).length;
    
    document.getElementById('statNew').textContent = onSite.length;
    document.getElementById('statPreReg').textContent = preRegs.length;
    document.getElementById('statPreAtt').textContent = prePresent;
    document.getElementById('statPrePerc').textContent = (preRegs.length > 0 ? (prePresent/preRegs.length*100).toFixed(1) : 0) + "%";
    document.getElementById('statSpeakers').textContent = attendees.filter(p => p.role === 'Speaker').length;
    document.getElementById('statOrg').textContent = attendees.filter(p => p.role === 'Organiser').length;
    document.getElementById('statTotalPres').textContent = totalPresent;
    document.getElementById('statTotalPerc').textContent = (attendees.length > 0 ? (totalPresent/attendees.length*100).toFixed(1) : 0) + "%";

    if(myChart) {
        myChart.data.datasets[0].data = [preRegs.length, totalPresent, onSite.length];
        myChart.update();
    }
}

function selectUserByName(name) {
    const p = attendees.find(u => u.name === name);
    if(!p) return;
    currentIdx = attendees.indexOf(p);
    document.getElementById('displayName').textContent = p.name;
    document.getElementById('valStatus').textContent = p.status;
    
    const btn = document.getElementById('btnMarkPresent');
    if(p.status.includes('‚úÖ')) {
        document.getElementById('valStatus').style.color = '#10b981';
        btn.textContent = "‚òí Mark Un-Present";
        btn.className = "btn btn-danger";
    } else {
        document.getElementById('valStatus').style.color = '#f72585';
        btn.textContent = "‚òë Mark Present";
        btn.className = "btn btn-success";
    }
    
    document.getElementById('valInstitution').textContent = p.institute; 
    document.getElementById('valCategory').textContent = p.role;
    document.getElementById('combinedDropdown').value = p.name;
}

function handleSearch(val) {
    const search = val.toLowerCase();
    const filtered = attendees.filter(p => p.name.toLowerCase().includes(search));
    if(filtered.length > 0) selectUserByName(filtered[0].name);
}

function handleFileUpload(input) {
    const reader = new FileReader();
    reader.onload = (e) => {
        processSyncData(e.target.result, false);
        filterRole('All'); updateStats();
    };
    reader.readAsText(input.files[0]);
}

function filterRole(role) {
    const dd = document.getElementById('combinedDropdown');
    dd.innerHTML = '<option value="">Select Participant...</option>';
    attendees.forEach(p => {
        if(role === 'All' || p.role.includes(role)) {
            const o = document.createElement('option'); o.value = p.name; o.textContent = p.name; dd.appendChild(o);
        }
    });
}

function toggleGeoFence() {
    isGeoFenceEnabled = !isGeoFenceEnabled;
    const b = document.getElementById('geoBtn');
    b.textContent = isGeoFenceEnabled ? "üìç Location: ON" : "üìç Location: OFF";
    b.style.background = isGeoFenceEnabled ? "#10b981" : "#636e72";
}

function handleCurtainClick() {
    if(!isGeoFenceEnabled) return document.getElementById('qrCurtain').classList.toggle('open');
    navigator.geolocation.getCurrentPosition(() => document.getElementById('qrCurtain').classList.add('open'));
}

function closeModal() { 
    document.getElementById('regModal').style.display='none'; 
    clearInterval(qrExpiryInterval);
}

function openCertLink() { window.open('D:/Symposium-4 CLFS/4th Symposium Certificates.html'); }

document.getElementById('combinedDropdown').onchange = (e) => selectUserByName(e.target.value);

window.onload = () => { 
    initChart();
    filterRole('All'); 
    updateStats();
    modalQR.append(document.getElementById("regModalQR")); 
    resetIdleTimer();
};
</script>
</body>
</html>