<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ASU CLFS 2026 - Certificate Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
        :root { --asu-blue: #1a3a82; --asu-gold: #f5a623; --asu-light: #f0f2f5; }
        body { font-family: 'Montserrat', sans-serif; background: var(--asu-light); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        .container { flex: 1; padding: 30px 15px; }
        .builder-card { background: white; padding: 30px; border-radius: 12px; max-width: 750px; margin: auto; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-top: 8px solid var(--asu-blue); }
        .header { text-align: center; margin-bottom: 30px; }
        .header img { max-height: 70px; margin-bottom: 10px; }
        .role-section { display: grid; grid-template-columns: 160px 1fr 1fr 150px; gap: 12px; align-items: center; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 8px; margin-bottom: 12px; transition: 0.3s; }
        .role-name { font-weight: bold; color: var(--asu-blue); font-size: 0.8em; border-left: 4px solid var(--asu-gold); padding-left: 10px; }
        .status-msg { font-size: 10.5px; color: #666; }
        .btn-gen { background: var(--asu-blue); color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 0.75em; }
        .btn-gen:disabled { background: #ddd; cursor: not-allowed; }
        input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; text-align: center; }
        footer { background: #222; color: #bbb; padding: 20px; text-align: center; font-size: 12px; border-top: 4px solid var(--asu-gold); margin-top: 20px; border-radius: 0 0 12px 12px; }
        footer a { color: var(--asu-gold); text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="builder-card" id="mainCard">
        <div class="header">
            <img src="https://raw.githubusercontent.com/hameedktk09/cms/main/clfs-logo.png" alt="ASU Logo">
            <h2>Symposium-4 CLFS 2026</h2>
            <p>Unified Certificate Portal Manager</p>
        </div>

        <div id="roleList">
            <div class="role-section" style="background: #fdfaf3;">
                <div class="role-name">PARTICIPANTS</div>
                <div class="status-msg" id="pdfStatP">Loading PDF...</div>
                <div class="status-msg" id="csvStatP">Syncing CSV...</div>
                <button class="btn-gen" id="btnP" onclick="generatePortal('Participant')" disabled> PARTICIPANTS PORTAL</button>
            </div>

            <div class="role-section">
                <div class="role-name">ORGANIZERS</div>
                <div class="status-msg" id="pdfStatO">Loading PDF...</div>
                <div class="status-msg" id="csvStatO">Syncing CSV...</div>
                <button class="btn-gen" id="btnO" onclick="generatePortal('Organizer')" disabled> ORGANIZERS PORTAL</button>
            </div>

            <div class="role-section">
                <div class="role-name">SPEAKERS</div>
                <div class="status-msg" id="pdfStatS">Loading PDF...</div>
                <div class="status-msg" id="csvStatS">Syncing CSV...</div>
                <button class="btn-gen" id="btnS" onclick="generatePortal('Speaker')" disabled> SPEAKERS PORTAL</button>
            </div>
        </div>
        
        <footer id="footer">
            <a href="https://www.asu.edu.om/" target="_blank">A'Sharqiyah University</a> | 2026
        </footer>
    </div>
</div>

<script>
    const GITHUB_RAW = "https://raw.githubusercontent.com/hameedktk09/cms/main/";
    
    let masterStore = {
        Participant: { pdf: "", data: [], templates: [GITHUB_RAW + "Participant.pdf"], csvs: [GITHUB_RAW + "4th%20Symposium%202026%20Participants.csv", GITHUB_RAW + "4th%20Symposium%202026%20On-Site%20Participants.csv"] },
        Organizer: { pdf: "", data: [], templates: [GITHUB_RAW + "Organizer.pdf"], csvs: [GITHUB_RAW + "4th%20Symposium%202026%20Organisers.csv"] },
        Speaker: { pdf: "", data: [], templates: [GITHUB_RAW + "Speakers.pdf"], csvs: [GITHUB_RAW + "4th%20Symposium%202026%20Speakers.csv"] }
    };

    async function initFetch() {
        for (const role in masterStore) {
            const short = role[0];
            try {
                const pdfRes = await fetch(masterStore[role].templates[0]);
                const pdfBlob = await pdfRes.blob();
                masterStore[role].pdf = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onloadend = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(pdfBlob);
                });
                document.getElementById(`pdfStat${short}`).innerHTML = "<span style='color:green'>✓ PDF Ready</span>";

                for (const url of masterStore[role].csvs) {
                    const csvRes = await fetch(url);
                    const arrayBuffer = await csvRes.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                    const mapped = json.map(r => {
                        const nameKey = Object.keys(r).find(k => k.toLowerCase().includes('name'));
                        const emailKey = Object.keys(r).find(k => k.toLowerCase().includes('email'));
                        const titleKey = Object.keys(r).find(k => k.toLowerCase().includes('title'));
                        return {
                            name: `${r[titleKey] || ''} ${r[nameKey] || ''}`.trim(),
                            email: (r[emailKey] || "").toLowerCase().trim()
                        };
                    }).filter(u => u.name && u.email);
                    masterStore[role].data.push(...mapped);
                }
                document.getElementById(`csvStat${short}`).innerHTML = `<span style='color:green'>✓ ${masterStore[role].data.length} Records</span>`;
                document.getElementById(`btn${short}`).disabled = false;
            } catch (err) {
                document.getElementById(`pdfStat${short}`).innerHTML = "<span style='color:red'>× Sync Error</span>";
            }
        }
    }

    function generatePortal(role) {
        const data = masterStore[role].data;
        const pdfBase64 = masterStore[role].pdf;
        const card = document.getElementById('mainCard');

        card.innerHTML = `
            <div class="header">
                <img src="https://raw.githubusercontent.com/hameedktk09/cms/main/ASU-logo.png" width="110">
                <h3>${role} Portal</h3>
                <p>Enter email to download your certificate</p>
            </div>
            <div style="text-align:center; padding: 10px;">
                <input type="email" id="userEmail" placeholder="example@email.com">
                <button id="downloadBtn" class="btn-gen" style="width:100%; padding:15px; font-size:1em;">DOWNLOAD CERTIFICATE</button>
                <p id="msg" style="margin-top:15px; font-size:13px; font-weight:bold;"></p>
                <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:var(--asu-blue); cursor:pointer; text-decoration:underline;">← Back to Selection</button>
            </div>
        `;

        document.getElementById('downloadBtn').onclick = async () => {
            const email = document.getElementById('userEmail').value.toLowerCase().trim();
            const user = data.find(u => u.email === email);
            const msg = document.getElementById('msg');

            if (!user) {
                msg.style.color = "red";
                msg.innerText = "Email not found. Use the email provided at registration.";
                return;
            }

            msg.style.color = "orange";
            msg.innerText = "Processing... please wait.";

            try {
                const pdfBytes = Uint8Array.from(atob(pdfBase64), c => c.charCodeAt(0));
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRomanBoldItalic);
                const page = pdfDoc.getPages()[0];
                
                const tw = font.widthOfTextAtSize(user.name, 34);
                page.drawText(user.name, {
                    x: (page.getSize().width / 2) - (tw / 2),
                    y: 322,
                    size: 34,
                    font,
                    color: PDFLib.rgb(0.1, 0.2, 0.4)
                });

                const finalPdf = await pdfDoc.save();
                const blob = new Blob([finalPdf], { type: "application/pdf" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${user.name}_Certificate.pdf`;
                link.click();
                
                msg.style.color = "green";
                msg.innerText = "Success! Your download should start shortly.";
            } catch (e) {
                msg.style.color = "red";
                msg.innerText = "Error generating PDF. Please try again.";
            }
        };
    }

    window.onload = initFetch;
</script>
</body>
</html>

