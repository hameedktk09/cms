<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ASU CLFS 2026 - Master Certificate Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
        :root { --asu-blue: #1a3a82; --asu-gold: #f5a623; --asu-light: #f0f2f5; }
        body { font-family: 'Montserrat', sans-serif; background: var(--asu-light); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        .container { flex: 1; padding: 40px 20px; }
        .builder-card { background: white; padding: 40px; border-radius: 12px; max-width: 1100px; margin: auto; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-top: 10px solid var(--asu-blue); }
        .header { text-align: center; margin-bottom: 40px; }
        .header img { max-height: 100px; margin: 0 10px; }
        .role-section { display: grid; grid-template-columns: 220px 1fr 1fr 200px; gap: 15px; align-items: center; padding: 20px; background: #fff; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; transition: 0.3s; }
        .role-section:hover { border-color: var(--asu-gold); }
        .role-name { font-weight: bold; color: var(--asu-blue); font-size: 0.85em; border-left: 5px solid var(--asu-gold); padding-left: 12px; }
        .status-msg { font-size: 11px; color: #666; font-style: italic; }
        .status-dot { font-size: 11px; margin-top: 4px; color: #28a745; font-weight: bold; }
        .btn-gen { background: var(--asu-blue); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.8em; transition: 0.3s; }
        .btn-gen:hover { background: var(--asu-gold); color: var(--asu-blue); }
        .btn-gen:disabled { background: #ccc; cursor: not-allowed; }
        footer { background: #222; color: #bbb; padding: 25px; text-align: center; font-size: 13px; border-top: 4px solid var(--asu-gold); line-height: 2; }
        footer a { color: var(--asu-gold); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="builder-card">
        <div class="header">
            <img src="https://raw.githubusercontent.com/hameedktk09/cms/main/ASU-logo.png" alt="ASU Logo">
            <img src="https://raw.githubusercontent.com/hameedktk09/cms/main/CLFS-logo.jpg" alt="CLFS Logo">
            <h2>Symposium-4 CLFS 2026</h2>
            <p>Unified Certificate Portal Manager (GitHub Auto-Fetch)</p>
        </div>

        <div class="role-section" style="background: #fdfaf3;">
            <div class="role-name">PARTICIPANTS<br><small>(Regular + On-Site)</small></div>
            <div class="status-msg" id="pdfStatP">Loading Template...</div>
            <div class="status-msg" id="csvStatP">Syncing CSV files...</div>
            <button class="btn-gen" id="btnP" onclick="generatePortal('Participant')" disabled>GENERATE PORTAL</button>
        </div>

        <div class="role-section">
            <div class="role-name">ORGANIZERS</div>
            <div class="status-msg" id="pdfStatO">Loading Template...</div>
            <div class="status-msg" id="csvStatO">Syncing CSV files...</div>
            <button class="btn-gen" id="btnO" onclick="generatePortal('Organizer')" disabled>GENERATE PORTAL</button>
        </div>

        <div class="role-section">
            <div class="role-name">SPEAKERS</div>
            <div class="status-msg" id="pdfStatS">Loading Template...</div>
            <div class="status-msg" id="csvStatS">Syncing CSV files...</div>
            <button class="btn-gen" id="btnS" onclick="generatePortal('Speaker')" disabled>GENERATE PORTAL</button>
        </div>
        <footer>
    <a href="https://www.asu.edu.om/" target="_blank">A'Sharqiyah University</a>: P.O Box 42, Postal Code:400 Ibra, Sultanate of Oman. <br>
    <a href="https://www.asu.edu.om/Page/Details/25?t=Centre%20for%20Language%20and%20Foundation%20Studies">Center For Language and Foundation Studies</a>. 
    Copyright &copy; <a href="mailto:hrehman08@yahoo.com">drkhan</a> 2026.
</footer>
    </div>
</div>

<script>
    const GITHUB_RAW = "https://raw.githubusercontent.com/hameedktk09/cms/main/";
    
    let masterStore = {
        Participant: { pdf: "", data: [], templates: [GITHUB_RAW + "Participant.pdf"], csvs: [GITHUB_RAW + "4th%20Symposium%202026%20Participants.csv", GITHUB_RAW + "4th%20Symposium%202026%20On-Site%20Participants.csv"] },
        Organizer: { pdf: "", data: [], templates: [GITHUB_RAW + "Organizer.pdf"], csvs: [GITHUB_RAW + "4th%20Symposium%202026%20Organisers.csv"] },
        Speaker: { pdf: "", data: [], templates: [GITHUB_RAW + "Speakers.pdf"], csvs: [GITHUB_RAW + "4th%20Symposium%202026%20Speakers.csv"] }
    };

    async function initFetch() {
        for (const role in masterStore) {
            const short = role[0];
            try {
                // Fetch PDF Template
                const pdfRes = await fetch(masterStore[role].templates[0]);
                const pdfBlob = await pdfRes.blob();
                masterStore[role].pdf = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onloadend = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(pdfBlob);
                });
                document.getElementById(`pdfStat${short}`).innerHTML = "<span style='color:green'>✓ Template Synced</span>";

                // Fetch CSV(s)
                for (const url of masterStore[role].csvs) {
                    const csvRes = await fetch(url);
                    const arrayBuffer = await csvRes.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                    const mapped = json.map(r => {
                        const nameKey = Object.keys(r).find(k => k.toLowerCase().includes('name'));
                        const emailKey = Object.keys(r).find(k => k.toLowerCase().includes('email'));
                        const titleKey = Object.keys(r).find(k => k.toLowerCase().includes('title'));
                        return {
                            name: `${r[titleKey] || ''} ${r[nameKey] || ''}`.trim(),
                            email: (r[emailKey] || "").toLowerCase().trim()
                        };
                    }).filter(u => u.name && u.email);
                    masterStore[role].data.push(...mapped);
                }

                // Deduplicate
                masterStore[role].data = Array.from(new Map(masterStore[role].data.map(item => [item.email, item])).values());
                document.getElementById(`csvStat${short}`).innerHTML = `<span style='color:green'>✓ ${masterStore[role].data.length} Records Synced</span>`;
                document.getElementById(`btn${short}`).disabled = false;

            } catch (err) {
                document.getElementById(`pdfStat${short}`).innerHTML = "<span style='color:red'>× Connection Error</span>";
            }
        }
    }

    function generatePortal(role) {
        const portalHtml = `
<!DOCTYPE html>
<html>
<head>
    <title>ASU Portal - ${role}</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"><\/script>
    <style>
        body { font-family: sans-serif; background: #1a3a82; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; color: white; }
        .card { background: white; color: #333; padding: 40px; border-radius: 15px; text-align: center; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 12px; margin: 20px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; text-align: center; }
        button { background: #f5a623; color: #1a3a82; border: none; padding: 12px 20px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="card">
        <img src="https://raw.githubusercontent.com/hameedktk09/cms/main/ASU-logo.png" width="150">
        <h3>${role} Certificate</h3>
        <input type="text" id="email" placeholder="Enter Registered Email">
        <button onclick="download()">Download PDF</button>
        <p id="msg" style="font-size:12px; margin-top:10px;"></p>
    </div>
    <script>
        const store = ${JSON.stringify({pdf: masterStore[role].pdf, data: masterStore[role].data})};
        async function download() {
            const email = document.getElementById('email').value.toLowerCase().trim();
            const user = store.data.find(u => u.email === email);
            if(!user) { document.getElementById('msg').innerText = "Email not found"; return; }
            
            const { PDFDocument, rgb, StandardFonts } = PDFLib;
            const doc = await PDFDocument.load(store.pdf);
            const font = await doc.embedFont(StandardFonts.TimesRomanBoldItalic);
            const page = doc.getPages()[0];
            const name = user.name;
            const tw = font.widthOfTextAtSize(name, 34);
            page.drawText(name, { x: (page.getSize().width/2)-(tw/2), y: 322, size: 34, font, color: rgb(0.1, 0.2, 0.4) });
            const bytes = await doc.save();
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([bytes], {type: "application/pdf"}));
            a.download = name + ".pdf"; a.click();
        }
    <\/script>
</body>
</html>`;

        const blob = new Blob([portalHtml], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Portal_${role}.html`;
        a.click();
    }

    window.onload = initFetch;
</script>
</body>
</html>