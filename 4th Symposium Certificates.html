<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>E-Certificates Generator - ASU CLFS 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
        body { font-family: 'Montserrat', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .builder-card { background: white; padding: 30px; border-radius: 12px; max-width: 900px; margin: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-top: 8px solid #1a3a82; }
        .header { text-align: center; margin-bottom: 30px; }
        .header img { max-height: 100px; margin-bottom: 10px; }
        .row { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; }
        .col { flex: 1; }
        .role-label { font-weight: bold; color: #1a3a82; border-left: 4px solid #f5a623; padding-left: 10px; font-size: 0.9em; text-transform: uppercase; }
        .status { font-size: 0.8em; color: #28a745; font-weight: bold; }
        .instructions { font-size: 0.85em; color: #555; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #ffc107; text-align: center;}
        .btn-build { background: #1a3a82; color: white; border: none; padding: 18px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 1.1em; transition: 0.3s; margin-top: 20px; box-shadow: 0 4px 10px rgba(26, 58, 130, 0.3); }
        .btn-build:disabled { background: #999; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-build:hover:not(:disabled) { background: #f5a623; color: #1a3a82; transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="builder-card">
    <div class="header">
        <img src="https://raw.githubusercontent.com/hameedktk09/cms/main/ASU-logo.png" alt="ASU Logo">
        <h2>E-Certificates Generator</h2>
        <p>Unified Management Portal for Participants, Organizers, and Speakers</p>
    </div>

    <div id="mainStatus" class="instructions">
        <strong>Status:</strong> Initializing connection to GitHub...
    </div>

    <div class="row">
        <div class="col" style="flex: 0.4;"><span class="role-label">PARTICIPANTS</span></div>
        <div class="col"><div id="statP" class="status">Loading assets...</div></div>
    </div>

    <div class="row">
        <div class="col" style="flex: 0.4;"><span class="role-label">ORGANIZERS</span></div>
        <div class="col"><div id="statO" class="status">Waiting...</div></div>
    </div>

    <div class="row">
        <div class="col" style="flex: 0.4;"><span class="role-label">SPEAKERS</span></div>
        <div class="col"><div id="statS" class="status">Waiting...</div></div>
    </div>

    <button id="btnBuild" class="btn-build" onclick="buildMasterPortal()" disabled>SYNCING DATA...</button>
</div>

<script>
    const REPO_BASE = "https://raw.githubusercontent.com/hameedktk09/cms/main/";
    const LOGO_URL = REPO_BASE + "ASU-logo.png";
    
    const fileMap = {
        Participant: {
            pdf: REPO_BASE + "Participant.pdf",
            csv: REPO_BASE + "4th%20Symposium%202026%20Participants.csv",
            statId: "statP"
        },
        Organizer: {
            pdf: REPO_BASE + "Organizer.pdf",
            csv: REPO_BASE + "4th%20Symposium%202026%20Organisers.csv",
            statId: "statO"
        },
        Speaker: {
            pdf: REPO_BASE + "Speakers.pdf",
            csv: REPO_BASE + "4th%20Symposium%202026%20Speakers.csv",
            statId: "statS"
        }
    };

    let store = { Participant: {}, Organizer: {}, Speaker: {} };

    async function blobToBase64(blob) {
        return new Promise(r => { 
            const reader = new FileReader(); 
            reader.onloadend = () => r(reader.result.split(',')[1]); 
            reader.readAsDataURL(blob); 
        });
    }

    window.onload = async () => {
        try {
            for (const role in fileMap) {
                document.getElementById(fileMap[role].statId).innerText = "⏳ Fetching...";
                const pdfRes = await fetch(fileMap[role].pdf);
                store[role].pdf = await blobToBase64(await pdfRes.blob());

                const csvRes = await fetch(fileMap[role].csv);
                const csvBuf = await csvRes.arrayBuffer();
                const wb = XLSX.read(csvBuf, { type: 'array' });
                
                store[role].data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).map(r => ({
                    name: `${r.Title || r.title || ''} ${r["Full Name"] || r["full name"] || ''}`.trim(),
                    email: (r["Email Address"] || r["Email address"] || r["Email"] || "").toLowerCase().trim()
                })).filter(u => u.email);

                document.getElementById(fileMap[role].statId).innerText = "✓ Sync Ready (" + store[role].data.length + " names)";
            }

            document.getElementById('mainStatus').innerHTML = "<strong>Success:</strong> All GitHub assets synced successfully.";
            document.getElementById('mainStatus').style.background = "#d4edda";
            document.getElementById('btnBuild').disabled = false;
            document.getElementById('btnBuild').innerText = "CREATE MASTER PORTAL FILE";

        } catch (e) {
            document.getElementById('mainStatus').innerHTML = "<strong>Error:</strong> Failed to fetch from GitHub. Check your internet or repository links.";
            document.getElementById('mainStatus').style.background = "#f8d7da";
        }
    };

    function buildMasterPortal() {
        const portalCode = `
<!DOCTYPE html>
<html>
<head>
    <title>ASU CLFS 2026 - Certificate Portal</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"><\/script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
        body { font-family: 'Montserrat', sans-serif; background: #1a3a82; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 380px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .logo { max-height: 100px; margin-bottom: 20px; }
        h3 { color: #1a3a82; margin: 0; font-size: 1.3em; border-bottom: 2px solid #f5a623; padding-bottom: 10px; display: inline-block; }
        p { color: #555; font-size: 0.9em; margin: 20px 0; line-height: 1.5; }
        input { width: 100%; padding: 14px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; text-align: center; outline: none; }
        .btn { background: #f5a623; color: #1a3a82; border: none; padding: 16px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 1em; }
        #msg { margin-top: 15px; font-size: 0.85em; font-weight: bold; min-height: 1.5em; }
    </style>
</head>
<body>
    <div class="card">
        <img src="${LOGO_URL}" class="logo">
        <br>
        <h3>Symposium 2026</h3>
        <p>Please enter your <b>registered email address</b> to download your certificate.</p>
        <input type="text" id="email" placeholder="Email Address">
        <button class="btn" onclick="verifyAndDownload()">DOWNLOAD CERTIFICATE</button>
        <div id="msg"></div>
    </div>
    <script>
        const masterStore = ${JSON.stringify(store)};
        const priority = ["Speaker", "Organizer", "Participant"];

        async function verifyAndDownload() {
            const input = document.getElementById('email').value.toLowerCase().trim();
            const msg = document.getElementById('msg');
            msg.style.color = "#666";
            msg.innerText = "Searching...";

            let userObj = null; let roleType = "";
            for (const role of priority) {
                const user = masterStore[role].data.find(u => u.email === input);
                if (user) { userObj = user; roleType = role; break; }
            }

            if (!userObj) {
                msg.style.color = "#d9534f";
                msg.innerText = "Email not found.";
                return;
            }

            try {
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const pdfB64 = masterStore[roleType].pdf;
                const doc = await PDFDocument.load(pdfB64);
                const font = await doc.embedFont(StandardFonts.TimesRomanBoldItalic);
                const page = doc.getPages()[0];
                const fontSize = 34;
                const textWidth = font.widthOfTextAtSize(userObj.name, fontSize);
                
                page.drawText(userObj.name, {
                    x: (page.getSize().width / 2) - (textWidth / 2),
                    y: 322,
                    size: fontSize,
                    font: font,
                    color: rgb(0.1, 0.2, 0.5)
                });

                const bytes = await doc.save();
                const a = document.createElement("a");
                a.href = URL.createObjectURL(new Blob([bytes], {type: "application/pdf"}));
                a.download = roleType + "_" + userObj.name.replace(/\\s+/g, '_') + ".pdf";
                a.click();
                msg.style.color = "green";
                msg.innerText = "Success! " + roleType + " certificate downloaded.";
            } catch (e) {
                msg.innerText = "Error generating PDF.";
            }
        }
    <\/script>
</body>
</html>`;

        const blob = new Blob([portalCode], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "ASU_Symposium_Portal.html";
        a.click();
    }
</script>
</body>
</html>

    function saveToLocal() {
        localStorage.setItem('certStore', JSON.stringify(store));
    }

    function clearStorage() {
        if(confirm("Clear all saved data?")) {
            localStorage.removeItem('certStore');
            location.reload();
        }
    }

    function bindFile(inputId, role, type, statusId) {
        document.getElementById(inputId).onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();

            if (type === 'pdf') {
                reader.onload = () => {
                    store[role].pdf = reader.result.split(',')[1];
                    saveToLocal();
                    document.getElementById(statusId || 'pdfStat'+role[0]).innerText = "✓ Template Updated";
                };
                reader.readAsDataURL(file);
            } else {
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, {type: 'array'});
                    store[role].data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).map(r => ({
                        name: `${r.Title || r.title || ''} ${r["Full Name"] || r["full name"]}`.trim(),
                        email: (r["Email Address"] || r["Email address"] || r["Email"] || "").toLowerCase().trim()
                    })).filter(u => u.name && u.email);
                    
                    saveToLocal();
                    document.getElementById(statusId).innerText = "✓ " + store[role].data.length + " Names Ready";
                };
                reader.readAsArrayBuffer(file);
            }
        };
    }

    bindFile('pdfP', 'Participant', 'pdf', 'pdfStatP'); bindFile('xlsxP', 'Participant', 'xlsx', 'statP');
    bindFile('pdfO', 'Organizer', 'pdf', 'pdfStatO');     bindFile('xlsxO', 'Organizer', 'xlsx', 'statO');
    bindFile('pdfS', 'Speaker', 'pdf', 'pdfStatS');       bindFile('xlsxS', 'Speaker', 'xlsx', 'statS');

    function buildMasterPortal() {
        if(!store.Participant.pdf || store.Participant.data.length === 0) {
            alert("Requirement: Please ensure at least Participant PDF and Excel are loaded.");
            return;
        }

        // The generated portal code remains the same as your logic
        const portalCode = `
<!DOCTYPE html>
<html>
<head>
    <title>ASU CLFS 2026 - Certificate Portal</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"><\/script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
        body { font-family: 'Montserrat', sans-serif; background: #1a3a82; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 380px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .logo { max-height: 90px; margin-bottom: 20px; }
        h3 { color: #1a3a82; margin: 0; font-size: 1.3em; border-bottom: 2px solid #f5a623; padding-bottom: 10px; display: inline-block; }
        p { color: #555; font-size: 0.9em; margin: 20px 0; line-height: 1.5; }
        input { width: 100%; padding: 14px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; text-align: center; outline: none; transition: 0.3s; }
        input:focus { border-color: #1a3a82; box-shadow: 0 0 5px rgba(26,58,130,0.2); }
        .btn { background: #f5a623; color: #1a3a82; border: none; padding: 16px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 1em; transition: 0.3s; }
        .btn:hover { background: #e0961f; transform: translateY(-2px); }
        #msg { margin-top: 15px; font-size: 0.85em; font-weight: bold; min-height: 1.5em; }
    </style>
</head>
<body>
    <div class="card">
        <img src="https://www.asu.edu.om/wp-content/uploads/2023/05/Logo.png" class="logo">
        <br>
        <h3>Symposium 2026</h3>
        <p>Please enter your <b>registered email address</b> to download your certificate.</p>
        <input type="text" id="email" placeholder="Email Address">
        <button class="btn" onclick="verifyAndDownload()">DOWNLOAD CERTIFICATE</button>
        <div id="msg"></div>
    </div>
    <script>
        const masterStore = ${JSON.stringify(store)};
        async function verifyAndDownload() {
            const input = document.getElementById('email').value.toLowerCase().trim();
            const msg = document.getElementById('msg');
            msg.style.color = "#666";
            msg.innerText = "Searching...";

            let userObj = null; let roleType = "";
            for (const role in masterStore) {
                const user = masterStore[role].data.find(u => u.email === input);
                if (user) { userObj = user; roleType = role; break; }
            }

            if (!userObj) {
                msg.style.color = "#d9534f";
                msg.innerText = "Email not found.";
                return;
            }

            try {
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const pdfB64 = masterStore[roleType].pdf;
                const doc = await PDFDocument.load(pdfB64);
                const font = await doc.embedFont(StandardFonts.TimesRomanBoldItalic);
                const page = doc.getPages()[0];
                const nameText = userObj.name;
                const fontSize = 34;
                const textWidth = font.widthOfTextAtSize(nameText, fontSize);
                
                page.drawText(nameText, {
                    x: (page.getSize().width / 2) - (textWidth / 2),
                    y: 322,
                    size: fontSize,
                    font: font,
                    color: rgb(0.1, 0.2, 0.5)
                });

                const bytes = await doc.save();
                const blob = new Blob([bytes], {type: "application/pdf"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = userObj.name.replace(/\\s+/g, '_') + "_Certificate.pdf";
                a.click();
                msg.style.color = "green";
                msg.innerText = "Downloaded!";
            } catch (e) {
                msg.innerText = "Error generating PDF.";
            }
        }
    <\/script>
</body>
</html>`;

        const blob = new Blob([portalCode], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "ASU_Symposium_Portal.html";
        a.click();
    }
</script>
</body>

</html>
